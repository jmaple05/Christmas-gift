<!DOCTYPE html>
<head>
    <title>Christmas present from me to you</title>
    <style>
        body {
            background-color: rgb(15, 15, 15);
        }
        .tree {
            font-family: monospace;
            white-space: pre;
            color: hsl(120,60%,25%);
        }
        @keyframes blink {
            0% {
                color: hsl(120,60%,25%);
            }
            90% {
                color: hsl(120,60%,25%);
            }
            95% {
                color: var(--light);
            }
            100% {
                color: hsl(120,60%,25%);
            }
        }
        @keyframes shouldBlink {
            0%, 100% {
                --blink-power: 1;
            }
            20%, 30% {
                --blink-power: 0;
            }

        }
        .star[style="--blink-power:0"] {
            color: hsl(120,60%,25%);
            animation: none;
        }
        .container{
            display: flex;
            align-items: flex-start;
            gap: 50px;
        }
        .lyrics {
            color: white;
            font-family: arial;
            font-size: 20px;
            white-space: pre-wrap;
            line-height: 40px;
        }
        .fade-char {
            opacity: 0;
            animation: fadeIn 1s forwards
        }
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }
        .startBtn {
            font-size: 30px;
        }
        #imageArea {
            margin-top: 50px;
            width: 400px;
            height: 200px;
            position: relative;
        }
        .song-image {
            position: absolute;
            width: 100%;
            height: auto;
            opacity: 0;
            transition: opacity 1s;
        }
        .song-image.show {
            opacity: 1;
            animation: fadeIn 1s;
        }
        .merry-message {
            position: fixed;
            top: 40%;
            left: 45%;
            transform: translate(-40%, -50%);
            color: white;
            font-family: arial;
            font-size: 60px;
            opacity: 0;
            transition: opacity 2s;
            pointer-events: none;
        }
        .merry-message.show {
            opacity: 1;
        }
        .love-message {
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-60%,-50%);
            color: white;
            font-family: arial;
            font-size: 60px;
            opacity: 0;
            transition: opacity 2s;
            pointer-events: none;
        }
        .love-message.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="tree" class="tree"></h1>
        <h1 id="lyrics" class="lyrics"></h1>
        <button id="startBtn" class="startBtn">Start Music</button>
        <audio id="song" src="Mariah_Carey_-All_I_Want_For_Christmas_Is_You.mp3"></audio>
        <div id="imageArea"></div>
        <div id="merry" class="merry-message">Merry Christmas ðŸŽ„</div>
        <div id="love" class="love-message">I love you all!</div>

        <script>
            const treeElement = document.getElementById("tree");
            const height = 12;
            let treeHTML = "";

            const light_colors = [
                "hsl(0,90%,60%)",       //red
                "hsl(210,90%,60%)",     //blue
                "hsl(0,0%,90%)",        //white
                "hsl(50,100%,60%)",     //yellow
                "hsl(140,80%,50%)"      //lighter green
            ];

            for (let i = 0; i < height; i++) {
                const spaces = " ".repeat(height - 1 - i);
                let star = spaces;
                for (let j = 0; j < 2 * i + 1; j++) {
                    let color = "hsl(120,60%,25%)";
                    if (i == 0) {
                        star += `<span style="color:hsl(60,100%,60%);">*</span>`
                    }
                    else {
                        color = light_colors[Math.floor(Math.random() * light_colors.length)];
                        const speed = (Math.random() * 1 + 2).toFixed(2);
                        const delay = (Math.random() * 2).toFixed(2);
                        star += `<span style="
                            --light:${color}; 
                            animation:  blink ${speed}s infinite,
                                        shouldBlink ${(Math.random()*3+1).toFixed(2)}s infinite;
                            animation-delay: ${delay}s;
                        " class="star">*</span>`;
                    }
                }
                treeHTML += star + "\n";
            }
            
            const trunkSpaces = " ".repeat(height-2);
            const trunk = `<span style="color: rgb(87, 54, 9)">|||</span>`;
            treeHTML += trunkSpaces + trunk + "\n";
            treeHTML += trunkSpaces + trunk + "\n";

            treeElement.innerHTML = treeHTML;

            const pictures = [
                {time: 12.8, image: "on_the_Y.jpg"},
                {time: 17.0, image: "car_ride.jpg"},
                {time: 21.0, image: "w_the_boyz.jpg"},
                {time: 24.1, image: "fhe_dinner.jpg"},
                {time: 28.2, image: "tree_of_life.jpg"},
                {time: 33.5, image: "the_boys_mish_call.jpg"},
                {time: 50.0, image: "lauren_mish_call.jpg"}
            ];

            function show_picture(image) {
                const area = document.getElementById("imageArea");

                const old = area.querySelector("img");
                if (old) {
                    old.classList.remove("show");
                    setTimeout(() => old.remove(), 1000);
                }

                const img = document.createElement("img");
                img.src = image;
                img.className = "song-image";

                area.appendChild(img);

                requestAnimationFrame(() => {
                    img.classList.add("show");
                });
            }

            const lyricsTimeline = [
                {time: 6.3, text: "I don't want a lot for Christmas", speed: 180},
                {time: 12.8, text: "There is just one thing I need", speed: 100},
                {time: 17.0, text: "I don't care about the presents", speed: 80},
                {time: 21.0, text: "Underneath the Christmas tree", speed: 80},
                {time: 24.1, text: "I just want you for my own", speed: 130},
                {time: 28.2, text: "More than you could ever know", speed: 115},
                {time: 33.5, text: "Make my wish come true", speed: 100},
                {time: 39.0, text: "All I want for Christmas is you", wordByWord: true, wordDelay: [660, 770, 330, 560, 2850, 4040]}
            ];

            function typeText(elementId, text, speed) {
                const parent = document.getElementById(elementId);
                
                const line = document.createElement("div");
                parent.appendChild(line);

                let index = 0;

                function typeNext() {
                    if (index >= text.length) return;

                    const span = document.createElement("span");
                    span.textContent = text[index];
                    span.classList.add("fade-char");
                    line.appendChild(span);

                    index++;
                    setTimeout(typeNext, speed);
                }
                typeNext();
            }

            function typeWords(elementId, text, delay) {
                const parent = document.getElementById(elementId);

                const line = document.createElement("div");
                parent.appendChild(line);

                const words = text.split(" ");
                let index = 0;

                function showNextWord() {
                    if (index >= words.length) return;

                    const wordContainer = document.createElement("span");

                    if (index > 0) {
                        wordContainer.appendChild(document.createTextNode(" "));
                    }
                    line.appendChild(wordContainer);

                    const letters = words[index].split("");
                    let c = 0;

                    function typeLetter() {
                        if (c >= letters.length) {
                            index++;
                            setTimeout(showNextWord, delay[index-1]);
                            return;
                        }

                        const charSpan = document.createElement("span");
                        charSpan.textContent = letters[c];
                        charSpan.classList.add("fade-char");
                        wordContainer.appendChild(charSpan);

                        c++;
                        setTimeout(typeLetter, 80);
                    }

                    typeLetter();

                }
                showNextWord();
            }

            const audio = document.getElementById("song");
            let currentLine = 0;
            let currentPicture = 0;

            document.getElementById("startBtn").onclick = () => {
                audio.play();
                document.getElementById("startBtn").style.display = "none";
            };

            const fadeStart = 54.0;
            const fadeDuration = 2500;
            let fading = false;

            audio.ontimeupdate = () => {
                const t = audio.currentTime;

                while (currentLine < lyricsTimeline.length && t >= lyricsTimeline[currentLine].time) {
                    if (lyricsTimeline[currentLine].wordByWord) {
                        const { text, wordDelay } = lyricsTimeline[currentLine]
                        typeWords("lyrics", text, wordDelay);
                    }
                    else {
                        const { text, speed } = lyricsTimeline[currentLine];
                        typeText("lyrics", text, speed);
                    }
                    currentLine++;
                }

                while (currentPicture < pictures.length && t >= pictures[currentPicture].time) {
                    show_picture(pictures[currentPicture].image);
                    currentPicture++;
                }

                while (!fading && t >= fadeStart) {
                    fading = true;

                    let startVolume = audio.volume;
                    const step = 100;
                    const volumeStep = startVolume / (fadeDuration / step);

                    const fade = setInterval(() => {
                        if (audio.volume - volumeStep > 0) {
                            audio.volume -= volumeStep;
                        }
                        else {
                            audio.volume = 0;
                            audio.pause();
                            clearInterval(fade);

                            document.getElementById("merry").classList.add("show");
                            document.getElementById("love").classList.add("show");
                            document.getElementById("imageArea").style.display = "none";
                            document.getElementById("lyrics").style.display = "none";
                        }
                    }, step);
                }
            };

        </script>

    </div>
    
</body>
